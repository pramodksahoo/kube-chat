# Story 3.1: Comprehensive User Activity Logging

## Status
**Draft** ✅

**Created By:** Bob (Scrum Master) - 2025-09-04
**Dependencies:** Epic 2 (user identity), Epic 1 (command operations)

## Story
**As a** compliance officer  
**I want** comprehensive audit logs of all user activities  
**so that** we can demonstrate regulatory compliance during audits

## Acceptance Criteria

1. System SHALL log 100% of user interactions including natural language inputs, generated commands, and execution results
2. System SHALL capture user identity, timestamp, session ID, and cluster context for each operation
3. System SHALL store audit logs in tamper-proof format with cryptographic integrity verification (SHA-256 checksums)
4. System SHALL retain audit logs according to configurable retention policies (minimum 7 years for compliance)
5. System SHALL never lose audit events even during system failures or high load conditions

## Tasks / Subtasks

- [ ] Task 1: Core Audit Event Data Models (AC: 1, 2)
  - [ ] Create `pkg/models/audit_event.go` with comprehensive audit event structure
  - [ ] Implement audit event builder pattern for consistent event creation
  - [ ] Add user identity context integration from Epic 2 User model
  - [ ] Create audit event types enumeration (Authentication, Command, Execution, etc.)
  - [ ] Add session context association from existing SessionAuthContext model
  - [ ] Implement cluster context capture (namespace, resource types, kubectl context)

- [ ] Task 2: Tamper-Proof Storage Infrastructure (AC: 3, 4)
  - [ ] Create `pkg/audit/storage.go` with PostgreSQL audit storage service
  - [ ] Implement cryptographic integrity verification using SHA-256 checksums
  - [ ] Design append-only audit table schema in PostgreSQL with CloudNativePG integration
  - [ ] Add configurable retention policies with automated cleanup workflows
  - [ ] Implement storage optimization for high-volume audit data
  - [ ] Create audit storage interface for future storage backend flexibility

- [ ] Task 3: Audit Event Collection Service (AC: 1, 5)
  - [ ] Create `cmd/audit-service/main.go` as dedicated audit microservice
  - [ ] Implement async event processing with NATS JetStream for reliability
  - [ ] Create audit event ingestion API endpoints
  - [ ] Add internal gRPC interfaces for high-performance logging from other services
  - [ ] Implement event buffering and retry logic for system failure scenarios
  - [ ] Add health checks and monitoring for audit service availability

- [ ] Task 4: Audit Integration Middleware (AC: 1, 2)
  - [ ] Create `pkg/middleware/audit_middleware.go` for HTTP request/response logging
  - [ ] Integrate with existing authentication middleware to capture user context
  - [ ] Add natural language input logging at API gateway level
  - [ ] Implement command execution result logging integration
  - [ ] Create session lifecycle event logging (login, logout, timeout)
  - [ ] Add RBAC decision logging for security monitoring

- [ ] Task 5: Service Integration and Testing (AC: 1, 5)
  - [ ] Integrate audit middleware with existing API gateway service
  - [ ] Update NLP service to emit command generation audit events
  - [ ] Update Kubernetes operator to emit command execution audit events
  - [ ] Add comprehensive unit tests with >80% coverage requirement
  - [ ] Create integration tests for end-to-end audit trail validation
  - [ ] Add load testing to validate no audit event loss under high load

## Dev Notes

**Priority:** P0 (Critical) - Essential for compliance and regulatory requirements
**Story Points:** 8
**Dependencies:**
- Epic 2 (Authentication & RBAC) - Complete. User identity context available via `pkg/models/user.go#User` and `pkg/models/user.go#SessionAuthContext`
- Epic 1 (NLP Foundation) - Complete. Command operations and natural language processing events ready for audit logging

**Previous Story Insights:**
Epic 2 completed comprehensive authentication and RBAC system providing essential user identity context and session management required for audit event association.

**Data Models:**
[Source: docs/architecture/tech-stack.md#database]
- **Database:** PostgreSQL 16+ with CloudNativePG operator for audit data storage
- **Async Processing:** NATS JetStream for reliable event processing
- **Storage:** Longhorn persistent volumes for audit data persistence
- **Encryption:** AES-256 for data at rest encryption via CloudNativePG

**API Specifications:**
[Source: docs/architecture.md#audit-service]
- POST /audit/log - Event ingestion with cryptographic integrity verification
- GET /audit/events - Searchable audit trail query with compliance filtering  
- gRPC interfaces for high-performance internal logging from services
- Health check endpoints for monitoring audit service availability

**Component Specifications:**
[Source: docs/architecture/source-tree.md#go-services]
- **Entry Point:** `cmd/audit-service/main.go` - Dedicated audit logging microservice
- **Models:** `pkg/models/audit_event.go` - Audit event data structures
- **Storage:** `pkg/audit/storage.go` - PostgreSQL storage with integrity verification
- **Middleware:** `pkg/middleware/audit_middleware.go` - HTTP request/response audit capture

**File Locations:**
[Source: docs/architecture/source-tree.md#file-organization-principles]
```
cmd/audit-service/           # Audit service main entry point
pkg/models/audit_event.go    # Core audit event models
pkg/audit/                   # Audit logging utilities and interfaces
  ├── storage.go            # PostgreSQL storage service
  ├── collector.go          # Event collection and processing
  └── integrity.go          # Cryptographic integrity verification
pkg/middleware/audit_middleware.go # HTTP audit middleware
charts/kubechat/templates/services/ # Audit service Kubernetes manifests
```

**Testing Requirements:**
[Source: docs/architecture/coding-standards.md#testing-standards]
- **Testing Framework:** Testify 1.9+ for Go testing with mock and assert capabilities
- **Test Location:** Tests co-located with source files (`*_test.go`)
- **Coverage Target:** >80% code coverage for audit services and middleware
- **Testing Approach:** Table-driven tests for audit event processing and storage scenarios

**Technical Constraints:**
[Source: docs/architecture/tech-stack.md#external-dependencies]
- **Go Version:** 1.22+ with effective Go patterns and error handling
- **PostgreSQL Integration:** CloudNativePG 1.21+ operator for production-ready database management
- **Async Processing:** NATS JetStream for reliable event processing without data loss
- **Security:** All audit data encrypted at rest and in transit, cryptographic integrity verification required

**Integration Points:**
- **User Context:** Leverage existing `pkg/models/user.go#SessionAuthContext` for user identity in audit events
- **Authentication:** Integrate with existing JWT middleware from Epic 2 for session association
- **Command Execution:** Hook into existing NLP service and Kubernetes operator command flows
- **RBAC Decisions:** Log permission validation results from Epic 2 RBAC middleware

**Project Structure Notes:**
Audit service follows established microservice pattern with dedicated entry point under `cmd/` and shared utilities under `pkg/`. Integration with existing CloudNativePG and NATS deployments via Helm chart templates.

## Testing

### Testing Standards
[Source: docs/architecture/coding-standards.md#testing-standards]

**Testing Framework:** Testify 1.9+ for Go testing with mock and assert capabilities
**Test Location:** Tests co-located with source files (`*_test.go`)
**Coverage Target:** >80% code coverage for audit services and middleware components
**Testing Approach:** Table-driven tests for various audit event scenarios and storage operations

**Specific Testing Requirements for Story 3.1:**
1. **Audit Event Model Testing:** Validation of audit event creation, serialization, and integrity verification
2. **Storage Layer Testing:** PostgreSQL integration with tamper-proof storage and retrieval operations
3. **Middleware Testing:** HTTP request/response audit capture and user context association
4. **Service Integration Testing:** End-to-end audit trail validation across all system components
5. **Performance Testing:** High-volume audit logging without data loss under load conditions
6. **Reliability Testing:** Audit event persistence during system failures and recovery scenarios

**Key Test Scenarios:**
- Comprehensive user interaction logging (natural language input → command generation → execution result)
- User identity and session context capture from Epic 2 authentication system
- Cryptographic integrity verification for tamper-proof audit storage
- Async event processing with NATS JetStream reliability guarantees
- Configurable retention policy enforcement and automated cleanup
- Audit service availability and health monitoring

**Load Testing Requirements:**
- Validate no audit event loss under 10,000+ events per minute
- Test async processing performance with NATS JetStream buffering
- Verify PostgreSQL storage performance with CloudNativePG optimization

**Integration Testing:**
- End-to-end audit trail from user request to command execution completion
- Integration with Epic 1 NLP service audit event emission
- Integration with Epic 2 authentication and RBAC audit logging
- Cross-service audit event correlation and integrity validation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-04 | 1.0 | Initial Story 3.1 creation with comprehensive audit logging requirements | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after story completion*